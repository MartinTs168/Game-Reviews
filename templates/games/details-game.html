{% extends 'common/base.html' %}
{% load static %}
{% load user_in_group_filter %}
{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'dist/quill.snow.css' %}">
    <link rel="stylesheet" href="{% static 'css/game-details.css' %}">
{% endblock %}
{% block content %}
    <div class="flex-container flex-wrap d-flex justify-content-around flex-md-row flex-sm-column">
        <div class="flex-container d-flex flex-column gap-5 pt-3 pb-3 mb-2 justify-content-sm-center justify-content-md-start">
            <div class="flex-container d-flex justify-content-sm-center p-1">
                {% if game.image %}
                    <div class="image-container">
                        <img src="{{ game.image.url }}" alt="" class="img-fluid p-1">
                    </div>
                {% else %}
                    <p>No image</p>
                {% endif %}
            </div>
            {% if user.is_authenticated %}
                <div class="align-self-center gap-3 flex-container d-flex flex-wrap flex-row-reverse">
                    <i class="bi bi-star-fill rating-button" data-value="5"></i>
                    <i class="bi bi-star-fill rating-button" data-value="4"></i>
                    <i class="bi bi-star-fill rating-button" data-value="3"></i>
                    <i class="bi bi-star-fill rating-button" data-value="2"></i>
                    <i class="bi bi-star-fill rating-button" data-value="1"></i>
                </div>
                <div class="align-self-center">
                    <p>Average rating: {{ avg_rating|floatformat:2 }}</p>
                </div>
            {% endif %}
        </div>

        <div class="flex-container d-flex flex-wrap p-3 row g-3 container-fluid" style="flex: 0 1 50%;">
            <h3>{{ game.name }}</h3>
            <div class="col-sm-12">
                {% for tag in game.tags.all %}
                    <p>{{ tag.name }}</p>
                {% endfor %}
            </div>
            <div class="col-sm-12"><p>{{ game.description }}</p></div>
            <div class="col-sm-6 col-lg-3"><p>Developer: {{ game.developer }}</p></div>
            <div class="col-sm-6 col-lg-3"><p>Publisher: {{ game.publisher }}</p></div>
            <div class="col-sm-6 col-lg-3"><p>Platforms: {{ game.available_platforms }}</p></div>
            <div class="col-sm-6 col-lg-3"><p>Release Date: {{ game.release_date }}</p></div>
            {% if user.is_authenticated %}
                <form method="post" id="review-form" action="{% url 'create-review' game_id=game.pk %}">
                    <div id="editor" class="quill-container">

                    </div>
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary w-100 mt-2 p-2">Add review</button>
                </form>
            {% endif %}
            {% if user|has_group:"Employee" %}
                <div class="w-100 flex-container d-flex justify-content-around gap-3 p-3">
                    <a href="{% url 'edit-game' game.pk %}" class="btn btn-secondary w-100">Edit</a>
                    <a href="{% url 'delete-game' game.pk %}" class="btn btn-danger w-100">Delete</a>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="d-flex flex-container flex-wrap justify-content-around p-2">
        <div class="w-100 p-4 flex-container flex-wrap d-flex flex-column gap-2">
            <h3>Reviews</h3>
            {% if curr_user_review %}
                <div class="card w-100">
                    <div class="card-body flex-container d-flex flex-row gap-2 justify-content-between">
                        <section class="flex-container d-flex flex-column gap-2 review-container">
                            <h5 class="card-title"><i>Your Review</i></h5>
                            <div class="card-text">
                                {{ curr_user_review.content }}
                            </div>
                        </section>
                        <div class="align-self-end">
                            <a href="{% url 'edit-review' curr_user_review.pk %}" class="btn btn-primary">
                                Edit
                            </a>
                            <a href="{% url 'delete-review' curr_user_review.pk %}" class="btn btn-danger">
                                Delete
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
            {% for review in game.reviews.all %}
                {% if review.author != user %}
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Author: <i>{{ review.author }}</i></h5>
                            <p class="card-text">{{ review.content }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'dist/quill.js' %}"></script>
    <script src="{% static 'js/add-review.js' %}"></script>
    <script>
        window.djangoInfo = {
            csrfToken: document.querySelector('[name=csrfmiddlewaretoken]').value,
            ratingCreateUrl: "{% url 'create-rating' pk=game.pk %}",
            ratingUpdateUrl: "{% url 'edit-rating' pk=game.pk %}",
            {% if curr_user_rating_value %}
                currUserRating: {{ curr_user_rating_value }},
            {% else %}
                currUserRating: null,
            {% endif %}
        };
    </script>
    <script src="{% static 'js/rating-events.js' %}"></script>
{% endblock %}
