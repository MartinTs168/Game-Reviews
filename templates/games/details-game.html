{% extends 'common/base.html' %}
{% load static %}
{% load user_in_group_filter %}
{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'dist/quill.snow.css' %}">
    <link rel="stylesheet" href="{% static 'css/game-details.css' %}">
{% endblock %}
{% block content %}
    <div class="flex-container flex-wrap d-flex justify-content-around">
        <div class="flex-item flex-container d-flex flex-column gap-5 pt-3 pb-3 mb-2">
            <div class="flex-item">
                {% if game.image %}
                    <img src="{{ game.image.url }}" alt="" class="img-fluid p-1">
                {% else %}
                    <p>No image</p>
                {% endif %}
            </div>
            {% if user.is_authenticated %}
                <div class="flex-item align-self-center gap-3 flex-container d-flex flex-wrap flex-row-reverse">
                    <i class="bi bi-star-fill rating-button" data-value="5"></i>
                    <i class="bi bi-star-fill rating-button" data-value="4"></i>
                    <i class="bi bi-star-fill rating-button" data-value="3"></i>
                    <i class="bi bi-star-fill rating-button" data-value="2"></i>
                    <i class="bi bi-star-fill rating-button" data-value="1"></i>
                </div>
            {% endif %}
        </div>

        <div class="flex-item flex-container d-flex flex-wrap p-3" style="flex: 0 0 50%;">
            <h3>{{ game.name }}</h3>
            <div class="w-100">
                {% for tag in game.tags.all %}
                    <p>{{ tag.name }}</p>
                {% endfor %}
            </div>
            <div class="w-100"><p>{{ game.description }}</p></div>
            <div class="w-100"><p>{{ game.developer }}</p></div>
            <div class="w-100"><p>{{ game.publisher }}</p></div>
            <div class="w-100"><p>{{ game.available_platforms }}</p></div>
            <div class="w-100"><p>{{ game.release_date }}</p></div>
            {% if user.is_authenticated %}
                <form method="post" id="review-form" action="{% url 'create-review' game_id=game.pk %}">
                    <div id="editor" style="height: 200px; width: 800px; margin-bottom: 10px;">

                    </div>
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Add review</button>
                </form>
            {% endif %}
            {% if user|has_group:"Employee" %}
                <div class="w-100">
                    <a href="{% url 'edit-game' game.pk %}" class="btn btn-secondary">Edit</a>
                    <a href="{% url 'delete-game' game.pk %}" class="btn btn-danger">Delete</a>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="d-flex flex-container flex-wrap justify-content-around">
        <div class="flex-item w-100 p-4">
            <h3>Reviews</h3>
            {% if curr_user_review %}
                <div class="card bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Author: <i>{{ curr_user_review.author }}</i></h5>
                        <p class="card-text">{{ curr_user_review.content }}</p>
                        <a href="{% url 'edit-review' curr_user_review.pk %}" class="btn btn-primary">
                            Edit
                        </a>
                        <a href="{% url 'delete-review' curr_user_review.pk %}" class="btn btn-danger">
                            Delete
                        </a>
                    </div>
                </div>
            {% endif %}
            {% for review in game.reviews.all %}
                {% if review.author != user %}
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Author: <i>{{ review.author }}</i></h5>
                            <p class="card-text">{{ review.content }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'dist/quill.js' %}"></script>
    <script src="{% static 'js/add-review.js' %}"></script>
    <script>
        window.djangoInfo = {
            csrfToken: document.querySelector('[name=csrfmiddlewaretoken]').value,
            ratingCreateUrl: "{% url 'create-rating' pk=game.pk %}",
            currUserRating: {{ curr_user_rating_value }},
        };
    </script>
    <script src="{% static 'js/rating-events.js' %}"></script>
{% endblock %}
